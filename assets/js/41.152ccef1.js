(window.webpackJsonp=window.webpackJsonp||[]).push([[41],{484:function(t,e,r){"use strict";r.r(e);var a=r(24),i=Object(a.a)({},function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[r("h1",{attrs:{id:"【转】前端黑科技：美团网页首帧优化实践"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#【转】前端黑科技：美团网页首帧优化实践","aria-hidden":"true"}},[t._v("#")]),t._v(" 【转】前端黑科技：美团网页首帧优化实践")]),t._v(" "),r("p",[t._v("转自："),r("a",{attrs:{href:"https://juejin.im/post/5bee7dd4e51d451f5b54cbb4",target:"_blank",rel:"noopener noreferrer"}},[t._v("前端黑科技：美团网页首帧优化实践"),r("OutboundLink")],1)]),t._v(" "),r("div",{staticClass:"tip custom-block"},[r("p",{staticClass:"custom-block-title"},[t._v("前言")]),t._v(" "),r("p",[t._v("自JavaScript诞生以来，前端技术发展非常迅速。移动端白屏优化是前端界面体验的一个重要优化方向，Web 前端诞生了 SSR 、CSR、预渲染等技术。在美团支付的前端技术体系里，通过预渲染提升网页首帧优化，从而优化了白屏问题，提升用户体验，并形成了最佳实践。")])]),t._v(" "),r("p",[t._v("在前端渲染领域，主要有以下几种方式可供选择：")]),t._v(" "),r("table",[r("thead",[r("tr",[r("th",{staticStyle:{"text-align":"center"}}),t._v(" "),r("th",{staticStyle:{"text-align":"center"}},[t._v("CSR")]),t._v(" "),r("th",{staticStyle:{"text-align":"center"}},[t._v("预渲染")]),t._v(" "),r("th",{staticStyle:{"text-align":"center"}},[t._v("SSR")]),t._v(" "),r("th",{staticStyle:{"text-align":"center"}},[t._v("同构")])])]),t._v(" "),r("tbody",[r("tr",[r("td",{staticStyle:{"text-align":"center"}},[t._v("优点")]),t._v(" "),r("td",{staticStyle:{"text-align":"center"}},[t._v("不依赖数据"),r("br"),t._v("FP 时间最快"),r("br"),t._v("客户端用户体验好"),r("br"),t._v("内存数据共享")]),t._v(" "),r("td",{staticStyle:{"text-align":"center"}},[t._v("不依赖数据"),r("br"),t._v("FCP 时间比 CSR 快"),r("br"),t._v("客户端用户体验好"),r("br"),t._v("内存数据共享")]),t._v(" "),r("td",{staticStyle:{"text-align":"center"}},[t._v("SEO 友好"),r("br"),t._v("首屏性能高，FMP 比 CSR 和预渲染快")]),t._v(" "),r("td",{staticStyle:{"text-align":"center"}},[t._v("SEO 友好"),r("br"),t._v("首屏性能高，FMP 比 CSR 和预渲染快"),r("br"),t._v("客户端用户体验好"),r("br"),t._v("内存数据共享"),r("br"),t._v("客户端与服务端代码公用，开发效率高")])]),t._v(" "),r("tr",[r("td",{staticStyle:{"text-align":"center"}},[t._v("缺点")]),t._v(" "),r("td",{staticStyle:{"text-align":"center"}},[t._v("SEO 不友好"),r("br"),t._v("FCP 、FMP 慢")]),t._v(" "),r("td",{staticStyle:{"text-align":"center"}},[t._v("SEO 不友好"),r("br"),t._v("FMP 慢")]),t._v(" "),r("td",{staticStyle:{"text-align":"center"}},[t._v("客户端数据共享成本高"),r("br"),t._v("模板维护成本高")]),t._v(" "),r("td",{staticStyle:{"text-align":"center"}},[t._v("Node 容易形成性能瓶颈")])])])]),t._v(" "),r("p",[t._v("通过对比，同构方案集合 CSR 与 SSR 的优点，可以适用于大部分业务场景。但由于在同构的系统架构中，连接前后端的 Node 中间层处于核心链路，系统可用性的瓶颈就依赖于 Node ，一旦作为短板的 Node 挂了，整个服务都不可用。")]),t._v(" "),r("p",[t._v("结合到我们团队负责的支付业务场景里，由于支付业务追求极致的系统稳定性，服务不可用直接影响到客诉和资损，因此我们采用浏览器端渲染的架构。在保证系统稳定性的前提下，还需要保障用户体验，所以采用了预渲染的方式。")]),t._v(" "),r("p",[t._v("那么究竟什么是预渲染呢？什么是 FCP/FMP 呢？我们先从最常见的 CSR 开始说起。")]),t._v(" "),r("p",[t._v("以 Vue 举例，常见的 CSR 形式如下：\n"),r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671b9d201124864?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}})]),t._v(" "),r("p",[t._v("一切看似很美好。然而，作为以用户体验为首要目标的我们发现了一个体验问题： "),r("strong",[t._v("首屏白屏问题")]),t._v("。")]),t._v(" "),r("h2",{attrs:{id:"为什么会首屏白屏"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#为什么会首屏白屏","aria-hidden":"true"}},[t._v("#")]),t._v(" 为什么会首屏白屏")]),t._v(" "),r("p",[t._v("浏览器渲染包含 HTML 解析、DOM 树构建、CSSOM 构建、JavaScript 解析、布局、绘制等等，大致如下图所示：\n"),r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671b9d4d735398e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}}),t._v("\n要搞清楚为什么会有白屏，就需要利用这个理论基础来对实际项目进行具体分析。通过 DevTools 进行分析：\n"),r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671b9db467e04ce?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}})]),t._v(" "),r("ul",[r("li",[t._v("等待 HTML 文档返回，此时处于白屏状态。")]),t._v(" "),r("li",[t._v("对 HTML 文档解析完成后进行首屏渲染，因为项目中对加了灰色的背景色，因此呈现出灰屏。")]),t._v(" "),r("li",[t._v("进行文件加载、JS 解析等过程，导致界面长时间出于灰屏中。")]),t._v(" "),r("li",[t._v("当 Vue 实例触发了 mounted 后，界面显示出大体框架。")]),t._v(" "),r("li",[t._v("调用 API 获取到时机业务数据后才能展示出最终的页面内容。")])]),t._v(" "),r("p",[t._v('由此得出结论，因为要等待文件加载、CSSOM 构建、JS 解析等过程，而这些过程比较耗时，导致用户会长时间出于不可交互的首屏灰白屏状态，从而给用户一种网页很"慢"的感觉。那么一个网页太"慢"，会造成什么影响呢？')]),t._v(" "),r("h2",{attrs:{id:"慢-的影响"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#慢-的影响","aria-hidden":"true"}},[t._v("#")]),t._v(' "慢" 的影响')]),t._v(" "),r("p",[r("a",{attrs:{href:"https://link.juejin.im/?target=https%3A%2F%2Fwww.cdnetworks.com%2Fresources%2Fwhitepapers%2Fus%2FGlobal%2520Web%2520Performance%2520Matters.pdf",target:"_blank",rel:"noopener noreferrer"}},[t._v("Global Web Performance Matters for ecommerce"),r("OutboundLink")],1),t._v("的报告中指出：\n"),r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671b9e1bfa6f066?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}})]),t._v(" "),r("ul",[r("li",[t._v("57%的用户更在乎网页在3秒内是否完成加载。")]),t._v(" "),r("li",[t._v("52%的在线用户认为网页打开速度影响到他们对网站的忠实度。")]),t._v(" "),r("li",[t._v("每慢1秒造成页面 PV 降低11%，用户满意度也随之降低降低16%。")]),t._v(" "),r("li",[t._v("近半数移动用户因为在10秒内仍未打开页面从而放弃。")])]),t._v(" "),r("p",[t._v('我们团队主要负责美团支付相关的业务，如果网站太慢会影响用户的支付体验，会造成客诉或资损。既然网站太"慢"会造成如此重要的影响，那要如何优化呢？')]),t._v(" "),r("h2",{attrs:{id:"优化思路"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#优化思路","aria-hidden":"true"}},[t._v("#")]),t._v(" 优化思路")]),t._v(" "),r("p",[t._v("在"),r("a",{attrs:{href:"https://link.juejin.im/?target=https%3A%2F%2Fdevelopers.google.com%2Fweb%2Ffundamentals%2Fperformance%2Fuser-centric-performance-metrics",target:"_blank",rel:"noopener noreferrer"}},[t._v("User-centric Performance Metrics"),r("OutboundLink")],1),t._v("一文中，共提到了4个页面渲染的关键指标：\n"),r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671b9e7a5cee36d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}}),t._v("\n基于这个理论基础，再回过头来看看之前项目的实际表现：")]),t._v(" "),r("p",[r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671b9e7a5db37ef?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}}),t._v("\n可见在 FP 的灰白屏界面停留了很长时间，用户不清楚网站是否有在正常加载，用户体验很差。")]),t._v(" "),r("p",[t._v("试想：如果我们可以将 FCP 或 FMP 完整的 HTML 文档提前到 FP 时机预渲染，用户看到页面框架，能感受到页面正在加载而不是冷冰冰的灰白屏，那么用户更愿意等待页面加载完成，从而降低了流失率。并且这种改观在弱网环境下更明显。")]),t._v(" "),r("p",[t._v("通过对比 FP、FCP、FMP 这三个时期 DOM 的差异，发现区别在于：\n"),r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671b9ea2aed5e3f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}}),t._v(" "),r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671b9ecc5e7490a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}}),t._v(" "),r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671b9f1a59700cb?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}})]),t._v(" "),r("ul",[r("li",[t._v("FP：仅有一个 div 根节点。")]),t._v(" "),r("li",[t._v("FCP：包含页面的基本框架，但没有数据内容。")]),t._v(" "),r("li",[t._v("FMP：包含页面所有元素及数据。")])]),t._v(" "),r("p",[t._v("仍然以 Vue 为例， 在其生命周期中，mounted 对应的是 FCP，updated 对应的是 FMP。那么具体应该使用哪个生命周期的 HTML 结构呢？")]),t._v(" "),r("table",[r("thead",[r("tr",[r("th",{staticStyle:{"text-align":"center"}}),t._v(" "),r("th",{staticStyle:{"text-align":"center"}},[t._v("mounted (FCP)")]),t._v(" "),r("th",{staticStyle:{"text-align":"center"}},[t._v("updated (FMP)")])])]),t._v(" "),r("tbody",[r("tr",[r("td",{staticStyle:{"text-align":"center"}},[t._v("缺点")]),t._v(" "),r("td",{staticStyle:{"text-align":"center"}},[t._v("只是视觉体验将 FCP 提前，"),r("br"),t._v("实际的 TTI 时间变化不大")]),t._v(" "),r("td",{staticStyle:{"text-align":"center"}},[t._v("构建时需要获取数据，编译速度慢"),r("br"),t._v("构建时与运行时的数据存在差异性"),r("br"),t._v("有复杂交互的页面，仍需等待，实际的 TTI 时间变化不大")])]),t._v(" "),r("tr",[r("td",{staticStyle:{"text-align":"center"}},[t._v("优点")]),t._v(" "),r("td",{staticStyle:{"text-align":"center"}},[t._v("不受数据影响，编译速度快")]),t._v(" "),r("td",{staticStyle:{"text-align":"center"}},[t._v("首屏体验好"),r("br"),t._v("对于纯展示类型的页面，FP 与 TTI 时间近乎一致")])])])]),t._v(" "),r("p",[t._v("通过以上的对比，最终选择在 mounted 时触发构建时预渲染。由于我们采用的是 CSR 的架构，没有 Node 作为中间层，因此要实现 DOM 内容的预渲染，就需要在项目构建编译时完成对原始模板的更新替换。")]),t._v(" "),r("p",[t._v("至此，我们明确了构建时预渲染的大体方案。")]),t._v(" "),r("h2",{attrs:{id:"构建时预渲染方案"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#构建时预渲染方案","aria-hidden":"true"}},[t._v("#")]),t._v(" 构建时预渲染方案")]),t._v(" "),r("p",[t._v("构建时预渲染流程：\n"),r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671b9f1a5ad59f8?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}})]),t._v(" "),r("h3",{attrs:{id:"配置读取"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#配置读取","aria-hidden":"true"}},[t._v("#")]),t._v(" 配置读取")]),t._v(" "),r("p",[t._v("由于 SPA 可以由多个路由构成，需要根据业务场景决定哪些路由需要用到预渲染。因此这里的配置文件主要是用于告知编译器需要进行预渲染的路由。")]),t._v(" "),r("p",[t._v("在我们的系统架构里，脚手架是基于 Webpack 自研的，在此基础上可以自定义自动化构建任务和配置。\n"),r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671b9f67159efa0?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}})]),t._v(" "),r("h3",{attrs:{id:"触发构建"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#触发构建","aria-hidden":"true"}},[t._v("#")]),t._v(" 触发构建")]),t._v(" "),r("p",[t._v("装饰器：\n"),r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671b9f8f840e092?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}}),t._v("\n使用：\n"),r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671b9fb30446feb?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}})]),t._v(" "),r("h3",{attrs:{id:"构建编译"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#构建编译","aria-hidden":"true"}},[t._v("#")]),t._v(" 构建编译")]),t._v(" "),r("p",[t._v("从流程图上，需要在发布机上启动模拟的浏览器环境，并通过预渲染的事件钩子获取当前的页面内容，生成最终的 HTML 文件。")]),t._v(" "),r("p",[t._v("通过 phantom 提供的 API 可获得当前 HTML，示例如下：\n"),r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671b9fe718b6ba9?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}}),t._v("\n为了提高构建效率，并行对配置的多个页面或路由进行预渲染构建，保证在 5S 内即可完成构建，流程图如下：\n"),r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671ba00ccca105a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}})]),t._v(" "),r("h2",{attrs:{id:"方案优化"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#方案优化","aria-hidden":"true"}},[t._v("#")]),t._v(" 方案优化")]),t._v(" "),r("p",[t._v("理想很丰满，现实很骨感。在实际投产中，构建时预渲染方案遇到了一个问题。")]),t._v(" "),r("p",[t._v("我们梳理一下简化后的项目上线过程：")]),t._v(" "),r("p",[r("strong",[t._v("开发 -> 编译 -> 上线")])]),t._v(" "),r("p",[t._v("假设本次修改了静态文件中的一个 JS 文件，这个文件会通过 CDN 方式在 HTML 里引用，那么最终在 HTML 文档中的引用方式是 "),r("code",[t._v('<script src="http://cdn.com/index.js"><\/script>')]),t._v("。然而由于项目还没有上线，所以其实通过完整 URL 的方式是获取不到这个文件的；而预渲染的构建又是在上线动作之前，所以问题就产生了：")]),t._v(" "),r("p",[r("strong",[t._v("构建时预渲染无法正常获取文件，导致编译报错")])]),t._v(" "),r("p",[t._v("怎么办？")]),t._v(" "),r("p",[r("strong",[t._v("请求劫持")])]),t._v(" "),r("p",[t._v("因为在做预渲染时，我们使用启动了一个模拟的浏览器环境，根据 phantom 提供的 API，可以对发出的请求加以劫持，将获取 CDN 文件的请求劫持到本地，从而在根本上解决了这个问题。示例代码如下：\n"),r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671ba03f7fb34b8?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}})]),t._v(" "),r("h2",{attrs:{id:"构建时预渲染研发流程及效果"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#构建时预渲染研发流程及效果","aria-hidden":"true"}},[t._v("#")]),t._v(" 构建时预渲染研发流程及效果")]),t._v(" "),r("p",[t._v("最终，构建时预渲染研发流程如下：\n"),r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671ba064530a227?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}}),t._v("\n开发阶段：")]),t._v(" "),r("ul",[r("li",[t._v("通过 TypeScript 的装饰器单行引入预渲染构建触发的方法。")]),t._v(" "),r("li",[t._v("发布前修改编译构建的配置文件。")])]),t._v(" "),r("p",[t._v("发布阶段：")]),t._v(" "),r("ul",[r("li",[t._v("先进行常规的项目构建。")]),t._v(" "),r("li",[t._v("若有预渲染相关配置，则触发预渲染构建。")]),t._v(" "),r("li",[t._v("通过预渲染得到最终的文件，并完成发布上线动作。")])]),t._v(" "),r("p",[t._v("完整的用户请求路径如下：\n"),r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671ba09446c6f33?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}}),t._v("\n通过构建时预渲染在项目中的使用，FCP 的时间相比之前减少了 75%。\n"),r("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2018/11/16/1671ba0b762ef2b0?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}})]),t._v(" "),r("h2",{attrs:{id:"作者简介"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#作者简介","aria-hidden":"true"}},[t._v("#")]),t._v(" 作者简介")]),t._v(" "),r("p",[t._v("寒阳，美团资深研发工程师，多年前端研发经历，负责美团支付钱包团队和美团支付前端基础技术。")])])},[],!1,null,null,null);i.options.__file="web-1.md";e.default=i.exports}}]);